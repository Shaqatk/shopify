{% comment %}
  A24 Purchase Bar
  
  Sticky purchase bar for A24 PDP with:
  - Subscription selector (one-time vs subscribe & save)
  - Cadence dropdown (bi-weekly/monthly selling plans)
  - Quantity selector (1-9 buttons, A24 style)
  - Add to cart button
  - Subscriber pricing display
{% endcomment %}

{% liquid
  assign product = closest.product
  assign variant = product.selected_or_first_available_variant
  
  # Check if product has selling plans (subscriptions)
  assign has_selling_plans = false
  if product.selling_plan_groups.size > 0
    assign has_selling_plans = true
  endif
  
  # Get initial quantity
  assign initial_quantity = variant.quantity_rule.min | default: 1
  
  # Check availability
  assign can_add_to_cart = false
  assign add_to_cart_text = 'products.product.unavailable' | t
  
  if variant.available
    assign can_add_to_cart = true
    assign add_to_cart_text = 'products.product.add_to_cart' | t
  else
    assign add_to_cart_text = 'products.product.sold_out' | t
  endif
%}

<div class="a24-purchase-bar" data-a24-purchase-bar>
  {%- assign product_form_id = 'A24-ProductForm-' | append: section.id -%}
  
  <product-form-component
    data-section-id="{{ section.id }}"
    data-product-id="{{ product.id }}"
    data-product-url="{{ product.url }}"
    on:submit="/handleSubmit"
    data-quantity-default="{{ initial_quantity }}"
  >
    {%- form 'product', product, id: product_form_id, data-type: 'add-to-cart-form', class: 'a24-purchase-form' -%}
      <input
        type="hidden"
        name="id"
        ref="variantId"
        value="{{ variant.id }}"
      >
      
      <div class="a24-purchase-bar__content">
        
        {%- comment -%} SUBSCRIPTION SELECTOR {%- endcomment -%}
        {% if has_selling_plans %}
          <div class="a24-subscription-selector" data-a24-subscription>
            <div class="a24-subscription__options">
              {%- comment -%} One-time purchase option {%- endcomment -%}
              <label class="a24-subscription__option">
                <input
                  type="radio"
                  name="purchase_option"
                  value="onetime"
                  checked
                  class="a24-subscription__radio"
                  data-onetime-radio
                >
                <span class="a24-subscription__label">
                  <span class="a24-subscription__title">One-time purchase</span>
                  <span class="a24-subscription__price">{{ variant.price | money }}</span>
                </span>
              </label>
              
              {%- comment -%} Subscribe & save option {%- endcomment -%}
              <label class="a24-subscription__option">
                <input
                  type="radio"
                  name="purchase_option"
                  value="subscription"
                  class="a24-subscription__radio"
                  data-subscription-radio
                >
                <span class="a24-subscription__label">
                  <span class="a24-subscription__title">Subscribe & save</span>
                  {% if product.selling_plan_groups.first.selling_plans.first %}
                    {% assign first_plan = product.selling_plan_groups.first.selling_plans.first %}
                    {% assign subscription_price = variant.price | times: first_plan.price_adjustments.first.value | divided_by: 100.0 %}
                    <span class="a24-subscription__price">
                      {{ subscription_price | money }}
                      <span class="a24-subscription__savings">(Save {{ first_plan.price_adjustments.first.value }}%)</span>
                    </span>
                  {% endif %}
                </span>
              </label>
            </div>
            
            {%- comment -%} Cadence dropdown (shown when subscription is selected) {%- endcomment -%}
            <div class="a24-subscription__cadence" data-cadence-selector style="display: none;">
              <label for="a24-cadence-{{ section.id }}" class="a24-subscription__cadence-label">
                Delivery frequency
              </label>
              <select
                id="a24-cadence-{{ section.id }}"
                name="selling_plan"
                class="a24-subscription__cadence-select"
                data-selling-plan-select
              >
                {% for selling_plan_group in product.selling_plan_groups %}
                  {% for selling_plan in selling_plan_group.selling_plans %}
                    <option
                      value="{{ selling_plan.id }}"
                      data-price-adjustment="{{ selling_plan.price_adjustments.first.value }}"
                    >
                      {{ selling_plan.name }}
                    </option>
                  {% endfor %}
                {% endfor %}
              </select>
            </div>
          </div>
        {% endif %}
        
        {%- comment -%} QUANTITY SELECTOR (1-9 buttons, A24 style) {%- endcomment -%}
        <div class="a24-quantity-selector" data-a24-quantity>
          <span class="a24-quantity__label">Quantity</span>
          <div class="a24-quantity__buttons">
            {% for i in (1..9) %}
              <button
                type="button"
                class="a24-quantity__button{% if i == initial_quantity %} active{% endif %}"
                data-quantity="{{ i }}"
                data-quantity-button
              >
                {{ i }}
              </button>
            {% endfor %}
          </div>
          <input
            type="hidden"
            name="quantity"
            value="{{ initial_quantity }}"
            data-quantity-input
          >
        </div>
        
        {%- comment -%} ADD TO CART BUTTON {%- endcomment -%}
        <button
          type="submit"
          name="add"
          class="a24-add-to-cart button"
          {% unless can_add_to_cart %}disabled{% endunless %}
          data-add-to-cart-button
        >
          <span class="a24-add-to-cart__text">{{ add_to_cart_text }}</span>
        </button>
        
      </div>
    {%- endform -%}
  </product-form-component>
</div>

{% stylesheet %}
  /* ============================================
     A24 Purchase Bar Styles
     ============================================ */
  
  .a24-purchase-bar {
    width: 100%;
  }

  .a24-purchase-form {
    width: 100%;
  }

  .a24-purchase-bar__content {
    display: flex;
    flex-direction: column;
    gap: var(--a24-space-3, 30px);
  }

  /* ============================================
     Subscription Selector
     ============================================ */
  
  .a24-subscription-selector {
    display: flex;
    flex-direction: column;
    gap: var(--a24-space-2, 20px);
  }

  .a24-subscription__options {
    display: flex;
    flex-direction: column;
    gap: var(--a24-space, 10px);
  }

  .a24-subscription__option {
    display: flex;
    align-items: flex-start;
    gap: var(--a24-space, 10px);
    padding: var(--a24-space-2, 20px);
    border: 1px solid #a8a8a8;
    cursor: pointer;
    transition: border-color 0.2s ease, background-color 0.2s ease;
  }

  .a24-subscription__option:hover {
    border-color: #000000;
  }

  .a24-subscription__option:has(input:checked) {
    border-color: #000000;
    background-color: rgba(0, 0, 0, 0.02);
  }

  .a24-subscription__radio {
    margin-top: 2px;
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    cursor: pointer;
  }

  .a24-subscription__label {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    cursor: pointer;
  }

  .a24-subscription__title {
    font-size: var(--a24-small-size, 0.875rem);
    font-weight: 600;
    letter-spacing: var(--a24-ls-wide, 0.02em);
    text-transform: uppercase;
    color: #000000;
  }

  .a24-subscription__price {
    font-size: var(--a24-h4-size, 1.125rem);
    font-weight: 700;
    letter-spacing: var(--a24-ls-normal, -0.01em);
    color: #000000;
  }

  .a24-subscription__savings {
    font-size: var(--a24-small-size, 0.875rem);
    font-weight: 400;
    color: #787878;
    margin-left: 8px;
  }

  /* Cadence Dropdown */
  .a24-subscription__cadence {
    display: flex;
    flex-direction: column;
    gap: var(--a24-space, 10px);
  }

  .a24-subscription__cadence-label {
    font-size: var(--a24-tiny-size, 0.6875rem);
    font-weight: 600;
    letter-spacing: var(--a24-ls-wider, 0.04em);
    text-transform: uppercase;
    color: #000000;
  }

  .a24-subscription__cadence-select {
    width: 100%;
    padding: var(--a24-space-2, 20px);
    font-family: var(--a24-font-family);
    font-size: var(--a24-small-size, 0.875rem);
    font-weight: 400;
    letter-spacing: var(--a24-ls-wide, 0.02em);
    text-transform: uppercase;
    color: #000000;
    background-color: #f1f1f1;
    border: 1px solid #a8a8a8;
    border-radius: 0;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23000000' stroke-width='2' stroke-linecap='square'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 20px center;
    padding-right: 50px;
  }

  .a24-subscription__cadence-select:hover {
    border-color: #000000;
  }

  .a24-subscription__cadence-select:focus {
    outline: 2px solid #000000;
    outline-offset: 2px;
  }

  /* ============================================
     Quantity Selector (1-9 Buttons)
     ============================================ */
  
  .a24-quantity-selector {
    display: flex;
    flex-direction: column;
    gap: var(--a24-space, 10px);
  }

  .a24-quantity__label {
    font-size: var(--a24-tiny-size, 0.6875rem);
    font-weight: 600;
    letter-spacing: var(--a24-ls-wider, 0.04em);
    text-transform: uppercase;
    color: #000000;
  }

  .a24-quantity__buttons {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 8px;
  }

  .a24-quantity__button {
    aspect-ratio: 1;
    min-width: 0;
    padding: 0;
    font-family: var(--a24-font-family);
    font-size: var(--a24-small-size, 0.875rem);
    font-weight: 400;
    letter-spacing: var(--a24-ls-normal, -0.01em);
    color: #000000;
    background-color: transparent;
    border: 1px solid #a8a8a8;
    border-radius: 0;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .a24-quantity__button:hover {
    border-color: #000000;
    background-color: rgba(0, 0, 0, 0.05);
  }

  .a24-quantity__button.active {
    background-color: #000000;
    color: #f1f1f1;
    border-color: #000000;
  }

  .a24-quantity__button:focus-visible {
    outline: 2px solid #000000;
    outline-offset: 2px;
  }

  /* ============================================
     Add to Cart Button
     ============================================ */
  
  .a24-add-to-cart {
    width: 100%;
    padding: var(--a24-space-2, 20px) var(--a24-space-3, 30px);
    font-family: var(--a24-font-family);
    font-size: var(--a24-small-size, 0.875rem);
    font-weight: 400;
    letter-spacing: var(--a24-ls-wide, 0.02em);
    text-transform: uppercase;
    color: #f1f1f1;
    background-color: #000000;
    border: 1px solid #000000;
    border-radius: 0;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .a24-add-to-cart:hover:not(:disabled) {
    background-color: #787878;
    border-color: #787878;
  }

  .a24-add-to-cart:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .a24-add-to-cart:focus-visible {
    outline: 2px solid #000000;
    outline-offset: 4px;
  }

  /* ============================================
     Mobile Adjustments
     ============================================ */
  
  @media screen and (max-width: 749px) {
    .a24-purchase-bar__content {
      gap: var(--a24-space-2, 20px);
    }

    .a24-quantity__buttons {
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .a24-subscription__option {
      padding: var(--a24-space, 10px) var(--a24-space-2, 20px);
    }

    .a24-add-to-cart {
      padding: var(--a24-space-2, 20px);
    }
  }

  /* ============================================
     Tablet Adjustments
     ============================================ */
  
  @media screen and (min-width: 750px) and (max-width: 1023px) {
    .a24-quantity__buttons {
      grid-template-columns: repeat(9, 1fr);
      gap: 6px;
    }
  }

{% endstylesheet %}

<script>
  // A24 Purchase Bar JavaScript
  (function() {
    const purchaseBar = document.querySelector('[data-a24-purchase-bar]');
    if (!purchaseBar) return;

    // Quantity selector
    const quantityButtons = purchaseBar.querySelectorAll('[data-quantity-button]');
    const quantityInput = purchaseBar.querySelector('[data-quantity-input]');

    quantityButtons.forEach(button => {
      button.addEventListener('click', function() {
        const quantity = this.dataset.quantity;
        
        // Update active state
        quantityButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // Update hidden input
        if (quantityInput) {
          quantityInput.value = quantity;
        }
      });
    });

    // Subscription selector
    const subscriptionRadios = purchaseBar.querySelectorAll('[data-onetime-radio], [data-subscription-radio]');
    const cadenceSelector = purchaseBar.querySelector('[data-cadence-selector]');
    const sellingPlanSelect = purchaseBar.querySelector('[data-selling-plan-select]');
    const subscriptionRadio = purchaseBar.querySelector('[data-subscription-radio]');
    const onetimeRadio = purchaseBar.querySelector('[data-onetime-radio]');

    if (subscriptionRadios.length > 0) {
      subscriptionRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'subscription' && cadenceSelector) {
            cadenceSelector.style.display = 'flex';
            if (sellingPlanSelect) {
              sellingPlanSelect.required = true;
            }
          } else if (cadenceSelector) {
            cadenceSelector.style.display = 'none';
            if (sellingPlanSelect) {
              sellingPlanSelect.required = false;
              sellingPlanSelect.value = '';
            }
          }
        });
      });
    }

    // Update price when cadence changes
    if (sellingPlanSelect) {
      sellingPlanSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const priceAdjustment = selectedOption.dataset.priceAdjustment;
        // Price update logic can be added here if needed
      });
    }
  })();
</script>
