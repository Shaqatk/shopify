{% comment %}
  A24 Purchase Bar
  
  Sticky purchase bar for A24 PDP with:
  - Subscription selector (one-time vs subscribe & save)
  - Cadence dropdown (bi-weekly/monthly selling plans)
  - Quantity selector (1-9 buttons, A24 style)
  - Add to cart button
  - Subscriber pricing display
{% endcomment %}

{% liquid
  assign product = closest.product
  assign variant = product.selected_or_first_available_variant
  
  # Check if product has selling plans (subscriptions)
  assign has_selling_plans = false
  assign monthly_plan = null
  if product.selling_plan_groups.size > 0
    assign has_selling_plans = true
    # Find monthly selling plan
    for selling_plan_group in product.selling_plan_groups
      for selling_plan in selling_plan_group.selling_plans
        if selling_plan.name contains 'month' or selling_plan.name contains 'Month'
          assign monthly_plan = selling_plan
          break
        endif
      endfor
    endfor
  endif
  
  # Calculate subscription price
  if monthly_plan
    assign subscription_price = variant.price | times: monthly_plan.price_adjustments.first.value | divided_by: 100.0
    assign savings_percent = monthly_plan.price_adjustments.first.value | abs
  endif
  
  # Get initial quantity
  assign initial_quantity = variant.quantity_rule.min | default: 1
  
  # Check availability
  assign can_add_to_cart = false
  assign add_to_cart_text = 'products.product.unavailable' | t
  
  if variant.available
    assign can_add_to_cart = true
    assign add_to_cart_text = 'products.product.add_to_cart' | t
  else
    assign add_to_cart_text = 'products.product.sold_out' | t
  endif
%}

<div class="a24-purchase-bar" data-a24-purchase-bar>
  {%- assign product_form_id = 'A24-ProductForm-' | append: section.id -%}
  
  <product-form-component
    data-section-id="{{ section.id }}"
    data-product-id="{{ product.id }}"
    data-product-url="{{ product.url }}"
    on:submit="/handleSubmit"
    data-quantity-default="{{ initial_quantity }}"
  >
    {%- form 'product', product, id: product_form_id, data-type: 'add-to-cart-form', class: 'a24-purchase-form' -%}
      <input
        type="hidden"
        name="id"
        ref="variantId"
        value="{{ variant.id }}"
      >
      
      <div class="a24-purchase-bar__content">
        
        {%- comment -%} PRICING DISPLAY (A24 Style) {%- endcomment -%}
        <div class="a24-pricing">
          {%- comment -%} Regular Price {%- endcomment -%}
          <div class="a24-pricing__regular">
            {{ variant.price | money }}
          </div>
          
          {%- comment -%} Member Price (if subscription available) {%- endcomment -%}
          {% if has_selling_plans and monthly_plan %}
            <div class="a24-pricing__member">
              <span class="a24-pricing__member-price">{{ subscription_price | money }}</span>
              <span class="a24-pricing__member-text">
                Members save {{ savings_percent }}% 
                <a href="/pages/aaa24" class="a24-pricing__join-link">Join us â†’</a>
              </span>
            </div>
            
            {%- comment -%} Hidden input for selling plan {%- endcomment -%}
            <input
              type="hidden"
              name="selling_plan"
              value="{{ monthly_plan.id }}"
              data-selling-plan-input
            >
          {% endif %}
        </div>
        
        {%- comment -%} QUANTITY SELECTOR (1-9 buttons, A24 style) {%- endcomment -%}
        <div class="a24-quantity-selector" data-a24-quantity>
          <span class="a24-quantity__label" id="a24-quantity-label-{{ section.id }}">
            Quantity
          </span>
          <div 
            class="a24-quantity__buttons" 
            role="radiogroup" 
            aria-labelledby="a24-quantity-label-{{ section.id }}"
            data-quantity-buttons
          >
            {% for i in (1..9) %}
              <button
                type="button"
                role="radio"
                class="a24-quantity__button{% if i == initial_quantity %} active{% endif %}"
                data-quantity="{{ i }}"
                data-quantity-button
                aria-checked="{% if i == initial_quantity %}true{% else %}false{% endif %}"
                aria-label="Quantity {{ i }}"
                tabindex="{% if i == initial_quantity %}0{% else %}-1{% endif %}"
              >
                {{ i }}
              </button>
            {% endfor %}
          </div>
          <input
            type="hidden"
            name="quantity"
            value="{{ initial_quantity }}"
            data-quantity-input
            aria-hidden="true"
          >
        </div>
        
        {%- comment -%} ADD TO CART BUTTON {%- endcomment -%}
        <button
          type="submit"
          name="add"
          class="a24-add-to-cart button"
          {% unless can_add_to_cart %}disabled{% endunless %}
          data-add-to-cart-button
        >
          <span class="a24-add-to-cart__text">{{ add_to_cart_text }}</span>
        </button>
        
      </div>
    {%- endform -%}
  </product-form-component>
</div>

{% stylesheet %}
  /* ============================================
     A24 Purchase Bar Styles
     ============================================ */
  
  .a24-purchase-bar {
    width: 100%;
  }

  .a24-purchase-form {
    width: 100%;
  }

  .a24-purchase-bar__content {
    display: flex;
    flex-direction: column;
    gap: var(--a24-space-3, 30px);
  }

  /* ============================================
     Pricing Display (A24 Style)
     ============================================ */
  
  .a24-pricing {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* Regular Price */
  .a24-pricing__regular {
    font-size: 2.625rem; /* 42px - H2 size */
    font-weight: 700;
    letter-spacing: -0.0375em;
    line-height: 1;
    color: #000000;
  }

  /* Member/Subscription Price */
  .a24-pricing__member {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .a24-pricing__member-price {
    font-size: 1.6875rem; /* 27px - slightly smaller than regular */
    font-weight: 400;
    letter-spacing: -0.025em;
    line-height: 1;
    color: #787878; /* Grey color like in image */
  }

  .a24-pricing__member-text {
    font-size: 0.6875rem; /* 11px - tiny size */
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    line-height: 1;
    color: #000000;
  }

  .a24-pricing__join-link {
    color: #000000;
    text-decoration: none;
    border-bottom: 1px solid #000000;
    transition: color 0.2s ease, border-color 0.2s ease;
  }

  .a24-pricing__join-link:hover {
    color: #787878;
    border-color: #787878;
  }

  /* ============================================
     Quantity Selector (1-9 Buttons)
     ============================================ */
  
  .a24-quantity-selector {
    display: flex;
    flex-direction: column;
    gap: var(--a24-space, 10px);
  }

  .a24-quantity__label {
    font-size: var(--a24-tiny-size, 0.6875rem);
    font-weight: 600;
    letter-spacing: var(--a24-ls-wider, 0.04em);
    text-transform: uppercase;
    color: #000000;
  }

  .a24-quantity__buttons {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 8px;
  }

  .a24-quantity__button {
    position: relative; /* For focus ring pseudo-element */
    aspect-ratio: 1;
    min-width: 0;
    padding: 0;
    font-family: var(--a24-font-family);
    font-size: var(--a24-small-size, 0.875rem);
    font-weight: 400;
    letter-spacing: var(--a24-ls-normal, -0.01em);
    color: #000000;
    background-color: transparent;
    border: 1px solid #a8a8a8;
    border-radius: 0;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .a24-quantity__button:hover {
    border-color: #000000;
    background-color: rgba(0, 0, 0, 0.05);
  }

  .a24-quantity__button.active {
    background-color: #000000;
    color: #f1f1f1;
    border-color: #000000;
  }

  .a24-quantity__button:focus {
    outline: none; /* Remove default outline */
  }

  .a24-quantity__button:focus-visible {
    outline: 2px solid #000000;
    outline-offset: 2px;
    z-index: 1; /* Ensure focus ring is visible above adjacent buttons */
  }

  /* Keyboard focus indicator (for better accessibility) */
  .a24-quantity__button:focus-visible::after {
    content: '';
    position: absolute;
    inset: -3px;
    border: 2px solid #000000;
    pointer-events: none;
  }

  /* Ensure active + focused state is clear */
  .a24-quantity__button.active:focus-visible {
    outline-color: #f1f1f1;
  }

  .a24-quantity__button.active:focus-visible::after {
    border-color: #f1f1f1;
  }

  /* ============================================
     Add to Cart Button
     ============================================ */
  
  .a24-add-to-cart {
    width: 100%;
    padding: var(--a24-space-2, 20px) var(--a24-space-3, 30px);
    font-family: var(--a24-font-family);
    font-size: var(--a24-small-size, 0.875rem);
    font-weight: 400;
    letter-spacing: var(--a24-ls-wide, 0.02em);
    text-transform: uppercase;
    color: #f1f1f1;
    background-color: #000000;
    border: 1px solid #000000;
    border-radius: 0;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .a24-add-to-cart:hover:not(:disabled) {
    background-color: #787878;
    border-color: #787878;
  }

  .a24-add-to-cart:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .a24-add-to-cart:focus-visible {
    outline: 2px solid #000000;
    outline-offset: 4px;
  }

  /* ============================================
     Mobile Adjustments
     ============================================ */
  
  @media screen and (max-width: 749px) {
    .a24-purchase-bar__content {
      gap: var(--a24-space-2, 20px);
    }

    .a24-pricing__regular {
      font-size: 2rem; /* Smaller on mobile */
    }

    .a24-pricing__member-price {
      font-size: 1.25rem;
    }

    .a24-quantity__buttons {
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .a24-add-to-cart {
      padding: var(--a24-space-2, 20px);
    }
  }

  /* ============================================
     Tablet Adjustments
     ============================================ */
  
  @media screen and (min-width: 750px) and (max-width: 1023px) {
    .a24-quantity__buttons {
      grid-template-columns: repeat(9, 1fr);
      gap: 6px;
    }
  }

{% endstylesheet %}

<script>
  // A24 Purchase Bar JavaScript with Full Accessibility
  (function() {
    const purchaseBar = document.querySelector('[data-a24-purchase-bar]');
    if (!purchaseBar) return;

    // Quantity selector
    const quantityButtons = purchaseBar.querySelectorAll('[data-quantity-button]');
    const quantityInput = purchaseBar.querySelector('[data-quantity-input]');
    const quantityButtonsContainer = purchaseBar.querySelector('[data-quantity-buttons]');

    if (!quantityButtons.length || !quantityInput) return;

    // Convert NodeList to Array for easier manipulation
    const buttonsArray = Array.from(quantityButtons);

    /**
     * Update quantity selection
     * @param {HTMLElement} button - The button to activate
     */
    function selectQuantity(button) {
      const quantity = button.dataset.quantity;
      
      // Update active state and ARIA attributes
      buttonsArray.forEach(btn => {
        const isSelected = btn === button;
        btn.classList.toggle('active', isSelected);
        btn.setAttribute('aria-checked', isSelected ? 'true' : 'false');
        btn.setAttribute('tabindex', isSelected ? '0' : '-1');
      });
      
      // Update hidden input
      quantityInput.value = quantity;
      
      // Focus the selected button
      button.focus();
    }

    /**
     * Get the index of the currently selected button
     * @returns {number} Index of active button
     */
    function getCurrentIndex() {
      return buttonsArray.findIndex(btn => btn.classList.contains('active'));
    }

    // Click handler
    quantityButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        selectQuantity(this);
      });
    });

    // Keyboard navigation (roving tabindex)
    quantityButtonsContainer.addEventListener('keydown', function(e) {
      const currentIndex = getCurrentIndex();
      let newIndex = currentIndex;

      switch(e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          e.preventDefault();
          newIndex = (currentIndex + 1) % buttonsArray.length;
          selectQuantity(buttonsArray[newIndex]);
          break;

        case 'ArrowLeft':
        case 'ArrowUp':
          e.preventDefault();
          newIndex = (currentIndex - 1 + buttonsArray.length) % buttonsArray.length;
          selectQuantity(buttonsArray[newIndex]);
          break;

        case 'Home':
          e.preventDefault();
          selectQuantity(buttonsArray[0]);
          break;

        case 'End':
          e.preventDefault();
          selectQuantity(buttonsArray[buttonsArray.length - 1]);
          break;

        case ' ':
        case 'Enter':
          e.preventDefault();
          // Re-select current button (in case user wants to confirm)
          selectQuantity(buttonsArray[currentIndex]);
          break;
      }
    });

    // Ensure only one button is tabbable on page load
    const activeButton = buttonsArray.find(btn => btn.classList.contains('active'));
    if (activeButton) {
      buttonsArray.forEach(btn => {
        btn.setAttribute('tabindex', btn === activeButton ? '0' : '-1');
      });
    }
  })();
</script>
