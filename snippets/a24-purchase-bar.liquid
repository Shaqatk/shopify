{% comment %}
  A24 Purchase Bar
  
  Sticky purchase bar for A24 PDP with:
  - Subscription selector (one-time vs subscribe & save)
  - Cadence dropdown (bi-weekly/monthly selling plans)
  - Quantity selector (1-9 buttons, A24 style)
  - Add to cart button
  - Subscriber pricing display
{% endcomment %}

{% liquid
  assign product = closest.product
  assign variant = product.selected_or_first_available_variant
  
  # Check if product has selling plans (subscriptions)
  assign has_selling_plans = false
  assign monthly_plan = null
  if product.selling_plan_groups.size > 0
    assign has_selling_plans = true
    # Find monthly selling plan
    for selling_plan_group in product.selling_plan_groups
      for selling_plan in selling_plan_group.selling_plans
        if selling_plan.name contains 'month' or selling_plan.name contains 'Month'
          assign monthly_plan = selling_plan
          break
        endif
      endfor
    endfor
  endif
  
  # Calculate subscription price
  if monthly_plan
    assign subscription_price = variant.price | times: monthly_plan.price_adjustments.first.value | divided_by: 100.0
    assign savings_percent = monthly_plan.price_adjustments.first.value | abs
  endif
  
  # Get initial quantity
  assign initial_quantity = variant.quantity_rule.min | default: 1
  
  # Check availability
  assign can_add_to_cart = false
  assign add_to_cart_text = 'products.product.unavailable' | t
  
  if variant.available
    assign can_add_to_cart = true
    assign add_to_cart_text = 'products.product.add_to_cart' | t
  else
    assign add_to_cart_text = 'products.product.sold_out' | t
  endif
%}

<div class="a24-purchase-bar" data-a24-purchase-bar>
  {%- assign product_form_id = 'A24-ProductForm-' | append: section.id -%}
  
  <product-form-component
    data-section-id="{{ section.id }}"
    data-product-id="{{ product.id }}"
    data-product-url="{{ product.url }}"
    on:submit="/handleSubmit"
    data-quantity-default="{{ initial_quantity }}"
  >
    {%- form 'product', product, id: product_form_id, data-type: 'add-to-cart-form', class: 'a24-purchase-form' -%}
      <input
        type="hidden"
        name="id"
        ref="variantId"
        value="{{ variant.id }}"
      >
      
      <div class="a24-purchase-bar__content">
        
        {%- comment -%} Hidden selling plan input (if available) {%- endcomment -%}
        {% if has_selling_plans and monthly_plan %}
          <input
            type="hidden"
            name="selling_plan"
            value="{{ monthly_plan.id }}"
            data-selling-plan-input
          >
        {% endif %}
        
        {%- comment -%} QUANTITY SELECTOR (A24 style - plain numbers with underlines) {%- endcomment -%}
        <div class="a24-quantity-selector" data-a24-quantity>
          <div class="a24-quantity__header">
            <span class="a24-quantity__label" id="a24-quantity-label-{{ section.id }}">
              QUANTITY
            </span>
          </div>
          <div 
            class="a24-quantity__numbers" 
            role="radiogroup" 
            aria-labelledby="a24-quantity-label-{{ section.id }}"
            data-quantity-buttons
          >
            {% for i in (1..9) %}
              <button
                type="button"
                role="radio"
                class="a24-quantity__number{% if i == initial_quantity %} active{% endif %}"
                data-quantity="{{ i }}"
                data-quantity-button
                aria-checked="{% if i == initial_quantity %}true{% else %}false{% endif %}"
                aria-label="Quantity {{ i }}"
                tabindex="{% if i == initial_quantity %}0{% else %}-1{% endif %}"
              >
                {{ i }}
              </button>
            {% endfor %}
          </div>
          <input
            type="hidden"
            name="quantity"
            value="{{ initial_quantity }}"
            data-quantity-input
            aria-hidden="true"
          >
        </div>
        
        {%- comment -%} ADD TO CART BUTTON {%- endcomment -%}
        <button
          type="submit"
          name="add"
          class="a24-add-to-cart button"
          {% unless can_add_to_cart %}disabled{% endunless %}
          data-add-to-cart-button
        >
          <span class="a24-add-to-cart__text">{{ add_to_cart_text }}</span>
        </button>
        
      </div>
    {%- endform -%}
  </product-form-component>
</div>

{% stylesheet %}
  /* ============================================
     A24 Purchase Bar Styles
     ============================================ */
  
  .a24-purchase-bar {
    width: 100%;
  }

  .a24-purchase-form {
    width: 100%;
  }

  .a24-purchase-bar__content {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 24px;
    align-items: end;
  }

  /* ============================================
     Quantity Selector (A24 Style - Plain Numbers)
     ============================================ */
  
  .a24-quantity-selector {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .a24-quantity__header {
    border-bottom: 1px solid #000000;
    padding-bottom: 8px;
  }

  .a24-quantity__label {
    font-size: 0.6875rem; /* 11px */
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: #000000;
    line-height: 1;
  }

  .a24-quantity__numbers {
    display: flex;
    gap: 16px;
    align-items: baseline;
  }

  .a24-quantity__number {
    position: relative;
    padding: 0;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    font-family: inherit;
    font-size: 1.125rem; /* 18px - smaller than before */
    font-weight: 400;
    letter-spacing: -0.01em;
    color: #a8a8a8; /* Grey by default */
    cursor: pointer;
    transition: all 0.2s ease;
    line-height: 1.4;
  }

  .a24-quantity__number:hover {
    color: #000000;
  }

  .a24-quantity__number.active {
    color: #000000;
    border-bottom-color: #000000;
    font-weight: 600;
  }

  .a24-quantity__number:focus {
    outline: none;
  }

  .a24-quantity__number:focus-visible {
    outline: 2px solid #000000;
    outline-offset: 4px;
  }

  /* ============================================
     Add to Cart Button (A24 Style - Outlined)
     ============================================ */
  
  .a24-add-to-cart {
    padding: 20px 48px;
    font-family: inherit;
    font-size: 0.875rem; /* 14px */
    font-weight: 400;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    color: #000000;
    background-color: transparent;
    border: 1px solid #000000;
    border-radius: 0;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .a24-add-to-cart:hover:not(:disabled) {
    background-color: #000000;
    color: #f1f1f1;
  }

  .a24-add-to-cart:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    border-color: #a8a8a8;
    color: #a8a8a8;
  }

  .a24-add-to-cart:focus-visible {
    outline: 2px solid #000000;
    outline-offset: 4px;
  }

  /* ============================================
     Mobile Adjustments
     ============================================ */
  
  @media screen and (max-width: 749px) {
    .a24-purchase-bar__content {
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .a24-quantity__numbers {
      gap: 12px;
      flex-wrap: wrap;
    }

    .a24-quantity__number {
      font-size: 1rem;
    }

    .a24-add-to-cart {
      width: 100%;
      padding: 16px 24px;
    }
  }

{% endstylesheet %}

<script>
  // A24 Purchase Bar JavaScript with Full Accessibility
  (function() {
    const purchaseBar = document.querySelector('[data-a24-purchase-bar]');
    if (!purchaseBar) return;

    // Quantity selector
    const quantityNumbers = purchaseBar.querySelectorAll('[data-quantity-button]');
    const quantityInput = purchaseBar.querySelector('[data-quantity-input]');
    const quantityNumbersContainer = purchaseBar.querySelector('[data-quantity-buttons]');

    if (!quantityNumbers.length || !quantityInput) return;

    // Convert NodeList to Array for easier manipulation
    const numbersArray = Array.from(quantityNumbers);

    /**
     * Update quantity selection
     * @param {HTMLElement} number - The number button to activate
     */
    function selectQuantity(number) {
      const quantity = number.dataset.quantity;
      
      // Update active state and ARIA attributes
      numbersArray.forEach(num => {
        const isSelected = num === number;
        num.classList.toggle('active', isSelected);
        num.setAttribute('aria-checked', isSelected ? 'true' : 'false');
        num.setAttribute('tabindex', isSelected ? '0' : '-1');
      });
      
      // Update hidden input
      quantityInput.value = quantity;
      
      // Focus the selected number
      number.focus();
    }

    /**
     * Get the index of the currently selected number
     * @returns {number} Index of active number
     */
    function getCurrentIndex() {
      return numbersArray.findIndex(num => num.classList.contains('active'));
    }

    // Click handler
    quantityNumbers.forEach(number => {
      number.addEventListener('click', function(e) {
        e.preventDefault();
        selectQuantity(this);
      });
    });

    // Keyboard navigation (roving tabindex)
    quantityNumbersContainer.addEventListener('keydown', function(e) {
      const currentIndex = getCurrentIndex();
      let newIndex = currentIndex;

      switch(e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          e.preventDefault();
          newIndex = (currentIndex + 1) % numbersArray.length;
          selectQuantity(numbersArray[newIndex]);
          break;

        case 'ArrowLeft':
        case 'ArrowUp':
          e.preventDefault();
          newIndex = (currentIndex - 1 + numbersArray.length) % numbersArray.length;
          selectQuantity(numbersArray[newIndex]);
          break;

        case 'Home':
          e.preventDefault();
          selectQuantity(numbersArray[0]);
          break;

        case 'End':
          e.preventDefault();
          selectQuantity(numbersArray[numbersArray.length - 1]);
          break;

        case ' ':
        case 'Enter':
          e.preventDefault();
          // Re-select current number (in case user wants to confirm)
          selectQuantity(numbersArray[currentIndex]);
          break;
      }
    });

    // Ensure only one number is tabbable on page load
    const activeNumber = numbersArray.find(num => num.classList.contains('active'));
    if (activeNumber) {
      numbersArray.forEach(num => {
        num.setAttribute('tabindex', num === activeNumber ? '0' : '-1');
      });
    }
  })();
</script>
