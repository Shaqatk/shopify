{% comment %}
  Product Information A24
  
  A24-style minimal PDP with:
  - Left column: sticky product details
  - Right column: sticky purchase bar + scrolling media stack
  - Subscription support (selling plans)
{% endcomment %}

{%- render 'a24-design-system' -%}

<script type="application/ld+json">
  {{ closest.product | structured_data }}
</script>

{% liquid
  # Capture product details block
  capture product_details
    content_for 'block', type: '_product-details', id: 'product-details', closest.product: closest.product
  endcapture

  capture additional_blocks
    content_for 'blocks'
  endcapture

  # Check if product has media
  assign product_has_media = true
  if closest.product.media.size == 0
    assign product_has_media = false
  endif

  # Get current variant for purchase bar
  assign current_variant = closest.product.selected_or_first_available_variant
  assign initial_quantity = current_variant.quantity_rule.min | default: 1
%}

<div
  class="product-information-a24 section section--full-width spacing-style relative"
  style="{% render 'spacing-style', settings: section.settings %} --gap: {{ section.settings.gap }}px;"
  data-testid="product-information-a24"
>
  <div class="product-information-a24__container">
    
    {%- comment -%} LEFT COLUMN: Product Details (sticky at bottom) {%- endcomment -%}
    <div class="product-information-a24__left">
      {%- comment -%} Spacer to push content down (A24 style) {%- endcomment -%}
      <div class="product-information-a24__spacer"></div>
      
      {%- comment -%} Content wrapper {%- endcomment -%}
      <div class="product-information-a24__left-content">
        {%- comment -%} A24 Pricing Display (injected after title via CSS order) {%- endcomment -%}
        <div class="product-information-a24__pricing">
          {% render 'a24-pricing-display' %}
        </div>
        
        {{ product_details }}
      </div>
    </div>

    {%- comment -%} RIGHT COLUMN: First Image → Sticky Cart Bar → Remaining Images {%- endcomment -%}
    <div class="product-information-a24__right">
      
      {% if product_has_media %}
        {%- comment -%} FIRST IMAGE {%- endcomment -%}
        {% assign first_media = closest.product.media | first %}
        <div class="a24-media-item a24-media-item--first">
          {% if first_media.media_type == 'image' %}
            <img
              src="{{ first_media | image_url: width: 1200 }}"
              alt="{{ first_media.alt | escape }}"
              width="{{ first_media.width }}"
              height="{{ first_media.height }}"
              loading="eager"
              class="a24-media-item__image"
            >
          {% elsif first_media.media_type == 'video' %}
            {{ first_media | video_tag: autoplay: true, loop: true, muted: true, controls: false }}
          {% elsif first_media.media_type == 'external_video' %}
            {{ first_media | external_video_tag }}
          {% endif %}
        </div>

        {%- comment -%} PRODUCT BAR - Sticky like A24 (position: sticky) {%- endcomment -%}
        <div class="a24-product-bar" data-a24-product-bar>
          <div class="a24-product-bar__grid">
            {%- comment -%} Quantity Column {%- endcomment -%}
            <div class="a24-product-bar__col a24-product-bar__col--quantity">
              {% render 'a24-purchase-bar', show_button: false %}
            </div>
            
            {%- comment -%} CTA/Button Column {%- endcomment -%}
            <div class="a24-product-bar__col a24-product-bar__col--cta">
              <button
                type="submit"
                form="A24-ProductForm-{{ section.id }}"
                name="add"
                class="a24-product-bar__cta"
                {% unless current_variant.available %}disabled{% endunless %}
                data-add-to-cart-button
              >
                <span class="a24-product-bar__cta-text">IN CART</span>
              </button>
            </div>
          </div>
        </div>

        {%- comment -%} REMAINING IMAGES {%- endcomment -%}
        {% if closest.product.media.size > 1 %}
          <div class="product-information-a24__media">
            {% for media in closest.product.media offset: 1 %}
              <div class="a24-media-item">
                {% if media.media_type == 'image' %}
                  <img
                    src="{{ media | image_url: width: 1200 }}"
                    alt="{{ media.alt | escape }}"
                    width="{{ media.width }}"
                    height="{{ media.height }}"
                    loading="lazy"
                    class="a24-media-item__image"
                  >
                {% elsif media.media_type == 'video' %}
                  {{ media | video_tag: autoplay: true, loop: true, muted: true, controls: false }}
                {% elsif media.media_type == 'external_video' %}
                  {{ media | external_video_tag }}
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}
      
    </div>

  </div>

  {{ additional_blocks }}
</div>

{% stylesheet %}
  /* ============================================
     A24 PDP Layout Styles - Phase 2 Refined
     ============================================ */
  
  .product-information-a24 {
    --a24-gap: 64px;
    --a24-left-width: 380px;
    --a24-right-max-width: 100%;
    --a24-purchase-bar-height: auto;
    --a24-header-offset: var(--header-height, 0px);
    --a24-sticky-top: 32px;
    
    /* Force A24 background color */
    background-color: #f1f1f1 !important;
    color: #000000 !important;
  }

  .product-information-a24__container {
    display: grid;
    grid-template-columns: var(--a24-left-width) 1fr;
    gap: var(--a24-gap);
    max-width: 100%;
    margin: 0 auto;
    padding: 48px 40px;
    align-items: stretch;
    min-height: calc(100vh - 100px);
  }

  /* LEFT COLUMN: Flex container to push content down */
  .product-information-a24__left {
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* Push content to bottom */
    align-items: flex-start;
    position: relative;
  }

  /* Spacer pushes content down */
  .product-information-a24__spacer {
    flex: 1 1 auto; /* Takes up available space */
    min-height: 100px; /* Minimum space above content */
  }

  /* Content wrapper at bottom */
  .product-information-a24__left-content {
    flex: 0 0 auto;
    width: 100%;
    position: sticky;
    bottom: 48px;
  }

  /* Left content wrapper - flex for ordering */
  .product-information-a24__left-content {
    display: flex;
    flex-direction: column;
  }

  /* Hide buy-buttons from left column (they go in purchase bar) */
  .product-information-a24__left .buy-buttons {
    display: none !important;
  }

  /* Hide default price block (we use custom A24 pricing) */
  .product-information-a24__left .price {
    display: none !important;
  }

  /* Hide accelerated checkout in left column */
  .product-information-a24__left .accelerated-checkout,
  .product-information-a24__left .shopify-payment-button {
    display: none !important;
  }

  /* A24 Pricing Display - positioned after title */
  .product-information-a24__pricing {
    order: 2;
    margin-top: 8px;
    margin-bottom: 32px;
  }

  /* Product details block */
  .product-information-a24__left .product-details {
    order: 3;
  }

  /* Product details group wrapper */
  .product-information-a24__left .product-details .group-block {
    display: flex;
    flex-direction: column;
  }

  /* Force specific elements to reorder within product details */
  .product-information-a24__left .product-details h1,
  .product-information-a24__left .product-details [class*="product-title"],
  .product-information-a24__left .product-details [class*="heading"] {
    order: 1;
  }

  /* RIGHT COLUMN: Media + Purchase Bar */
  .product-information-a24__right {
    display: flex;
    flex-direction: column;
    gap: 0; /* Tighter layout - gaps controlled individually */
    max-width: var(--a24-right-max-width);
    width: 100%;
  }

  /* First image - no margin */
  .a24-media-item--first {
    margin-bottom: 0;
  }

  /* Purchase Bar (at bottom of right column, NOT sticky on desktop) */
  .product-information-a24__purchase-bar {
    position: relative;
    z-index: 10;
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 0;
    max-width: 500px; /* Narrower like A24 */
    width: 100%;
  }

  .a24-purchase-bar__content {
    /* Will be styled in Phase 3 */
  }

  /* ============================================
     A24 Media Stack - Simple Vertical Scroll
     No carousel, no lightbox, no interactions
     ============================================ */
  
  .product-information-a24__media {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }

  /* Individual media item container */
  .a24-media-item {
    width: 100%;
    position: relative;
  }

  /* Images - simple, non-interactive */
  .a24-media-item__image {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
    pointer-events: none;
    cursor: default;
    user-select: none;
    -webkit-user-drag: none;
  }

  /* Videos */
  .a24-media-item video {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
  }

  /* No hover effects */
  .a24-media-item:hover {
    transform: none;
    box-shadow: none;
  }

  /* ============================================
     A24 Product Bar - Sticky like A24.com
     Uses position: sticky so button stays in place
     ============================================ */
  
  .a24-product-bar {
    position: sticky;
    top: -1px; /* A24 uses -1px */
    z-index: 100;
    background: #f1f1f1;
    padding: 24px 0;
    margin-bottom: 24px;
    width: 100%;
  }

  /* Grid layout: Quantity on left, Button on right */
  .a24-product-bar__grid {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 24px;
    align-items: flex-end;
    width: 100%;
  }

  /* Quantity column */
  .a24-product-bar__col--quantity {
    transition: opacity 0.3s ease;
  }

  /* CTA/Button column - right aligned */
  .a24-product-bar__col--cta {
    display: flex;
    justify-content: flex-end;
    align-items: flex-end;
  }

  /* The Add to Cart button (A24 style) */
  .a24-product-bar__cta {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 28px 72px;
    font-family: inherit;
    font-size: 0.8125rem;
    font-weight: 400;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #000000;
    background-color: transparent;
    border: 1px solid #000000;
    border-radius: 0;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    min-width: 200px;
  }

  .a24-product-bar__cta:hover:not(:disabled) {
    background-color: #000000;
    color: #ffffff;
  }

  .a24-product-bar__cta:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    border-color: #a8a8a8;
    color: #a8a8a8;
  }

  /* ============================================
     PINNED STATE - When bar is stuck at top
     ============================================ */
  
  .a24-product-bar.state-pinned {
    background: transparent;
  }

  /* Hide quantity when pinned (opacity, not display) */
  .a24-product-bar.state-pinned .a24-product-bar__col--quantity {
    opacity: 0;
    pointer-events: none;
  }

  /* Button turns BLACK when pinned */
  .a24-product-bar.state-pinned .a24-product-bar__cta {
    background-color: #000000;
    color: #ffffff;
    border-color: #000000;
  }

  .a24-product-bar.state-pinned .a24-product-bar__cta:hover:not(:disabled) {
    background-color: #333333;
    border-color: #333333;
  }

  /* Gap before remaining images */
  .product-information-a24__media {
    margin-top: 0;
  }

  /* MOBILE: Single column, purchase bar at bottom */
  @media screen and (max-width: 749px) {
    .product-information-a24 {
      --a24-sticky-top: 16px;
    }

    .product-information-a24__container {
      grid-template-columns: 1fr;
      gap: 24px;
      padding: 24px var(--padding-md, 16px) 160px;
      min-height: auto;
      align-items: flex-start;
    }

    .product-information-a24__left {
      position: static;
      order: 1;
      justify-content: flex-start;
    }

    .product-information-a24__spacer {
      display: none;
    }

    .product-information-a24__left-content {
      position: static;
    }

    .product-information-a24__left .buy-buttons {
      display: none !important;
    }

    .product-information-a24__right {
      order: 0;
      max-width: 100%;
    }

    /* Product bar - fixed at bottom on mobile */
    .a24-product-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: auto;
      z-index: 100;
      background: #f1f1f1;
      border-top: 1px solid #a8a8a8;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin: 0;
    }

    .a24-product-bar__grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .a24-product-bar__col--cta {
      justify-content: stretch;
    }

    .a24-product-bar__cta {
      width: 100%;
      padding: 20px 24px;
    }

    /* On mobile, never use pinned behavior */
    .a24-product-bar.state-pinned {
      background: #f1f1f1;
    }

    .a24-product-bar.state-pinned .a24-product-bar__col--quantity {
      opacity: 1;
      pointer-events: auto;
    }

    .a24-product-bar.state-pinned .a24-product-bar__cta {
      background-color: transparent;
      color: #000000;
      border-color: #000000;
    }

    .product-information-a24__media {
      order: 1;
      gap: 12px;
    }
  }

  /* TABLET: Adjust left column width */
  @media screen and (min-width: 750px) and (max-width: 1023px) {
    .product-information-a24 {
      --a24-left-width: 320px;
      --a24-gap: 48px;
    }

    .product-information-a24__container {
      padding: 32px 24px;
    }

    .a24-product-bar__cta {
      padding: 24px 48px;
      min-width: 180px;
    }
  }

  /* Hide the separate sticky button from purchase bar - we use position:sticky now */
  .a24-sticky-button {
    display: none !important;
  }

  /* LARGE DESKTOP: Maintain full-width feel */
  @media screen and (min-width: 1400px) {
    .product-information-a24 {
      --a24-left-width: 420px;
      --a24-gap: 80px;
    }

    .product-information-a24__container {
      padding: 64px 60px;
    }
  }

  /* If header is sticky, adjust offset */
  body:has(#header-group #header-component[data-sticky-state='active']) .product-information-a24 {
    --a24-header-offset: var(--header-height);
  }

  /* Minimal typography overrides for A24 aesthetic */
  .product-information-a24__left h1 {
    font-weight: 400;
    letter-spacing: -0.02em;
  }

  .product-information-a24__left .price {
    font-weight: 500;
  }

  /* Smooth scroll behavior */
  .product-information-a24__left {
    scroll-behavior: smooth;
  }

{% endstylesheet %}

<script>
  // A24 Product Bar - Detect when sticky bar becomes pinned
  (function() {
    const productBar = document.querySelector('[data-a24-product-bar]');
    if (!productBar) return;

    // Use IntersectionObserver to detect when bar is pinned
    // When the bar's top edge goes past the viewport top, it's pinned
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          // When not intersecting and the bar is above viewport = pinned
          if (!entry.isIntersecting && entry.boundingClientRect.top < 0) {
            productBar.classList.add('state-pinned');
          } else {
            productBar.classList.remove('state-pinned');
          }
        });
      },
      {
        threshold: [1], // Trigger when fully visible/hidden
        rootMargin: '1px 0px 0px 0px' // Match the -1px top
      }
    );

    observer.observe(productBar);

    // Also use scroll for more precise control (backup)
    let ticking = false;
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          const rect = productBar.getBoundingClientRect();
          // If the bar's top is at or above 0 (stuck), add pinned class
          if (rect.top <= 0) {
            productBar.classList.add('state-pinned');
          } else {
            productBar.classList.remove('state-pinned');
          }
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });
  })();
</script>

{% schema %}
{
  "name": "Product Information A24",
  "class": "section-product-information-a24",
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "content-center-aligned",
          "label": "t:options.page"
        },
        {
          "value": "content-full-width",
          "label": "t:options.full"
        }
      ],
      "default": "content-full-width"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "t:settings.media_position",
      "options": [
        {
          "value": "left",
          "label": "t:options.left"
        },
        {
          "value": "right",
          "label": "t:options.right"
        }
      ],
      "default": "right",
      "info": "A24 layout always shows media on right"
    },
    {
      "type": "checkbox",
      "id": "equal_columns",
      "label": "t:settings.equal_columns",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "limit_details_width",
      "label": "t:settings.limit_product_details_width",
      "default": false
    },
    {
      "type": "range",
      "id": "gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 96,
      "step": 4,
      "unit": "px",
      "default": 48
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": []
}
{% endschema %}
