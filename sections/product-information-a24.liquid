{% comment %}
  Product Information A24
  
  A24-style minimal PDP with:
  - Left column: sticky product details
  - Right column: sticky purchase bar + scrolling media stack
  - Subscription support (selling plans)
{% endcomment %}

{%- render 'a24-design-system' -%}

<script type="application/ld+json">
  {{ closest.product | structured_data }}
</script>

{% liquid
  # Capture product details block
  capture product_details
    content_for 'block', type: '_product-details', id: 'product-details', closest.product: closest.product
  endcapture

  capture additional_blocks
    content_for 'blocks'
  endcapture

  # Check if product has media
  assign product_has_media = true
  if closest.product.media.size == 0
    assign product_has_media = false
  endif

  # Get current variant for purchase bar
  assign current_variant = closest.product.selected_or_first_available_variant
  assign initial_quantity = current_variant.quantity_rule.min | default: 1
%}

<div
  class="product-information-a24 section section--full-width spacing-style relative"
  style="{% render 'spacing-style', settings: section.settings %} --gap: {{ section.settings.gap }}px;"
  data-testid="product-information-a24"
>
  <div class="product-information-a24__container">
    
    {%- comment -%} LEFT COLUMN: Product Details (sticky at bottom) {%- endcomment -%}
    <div class="product-information-a24__left">
      {%- comment -%} Spacer to push content down (A24 style) {%- endcomment -%}
      <div class="product-information-a24__spacer"></div>
      
      {%- comment -%} Content wrapper {%- endcomment -%}
      <div class="product-information-a24__left-content">
        {%- comment -%} A24 Pricing Display (injected after title via CSS order) {%- endcomment -%}
        <div class="product-information-a24__pricing">
          {% render 'a24-pricing-display' %}
        </div>
        
        {{ product_details }}
      </div>
    </div>

    {%- comment -%} RIGHT COLUMN: First Image → Cart Controls → Remaining Images {%- endcomment -%}
    <div class="product-information-a24__right">
      
      {% if product_has_media %}
        {%- comment -%} FIRST IMAGE {%- endcomment -%}
        {% assign first_media = closest.product.media | first %}
        <div class="a24-media-item a24-media-item--first">
          {% if first_media.media_type == 'image' %}
            <img
              src="{{ first_media | image_url: width: 1200 }}"
              alt="{{ first_media.alt | escape }}"
              width="{{ first_media.width }}"
              height="{{ first_media.height }}"
              loading="eager"
              class="a24-media-item__image"
            >
          {% elsif first_media.media_type == 'video' %}
            {{ first_media | video_tag: autoplay: true, loop: true, muted: true, controls: false }}
          {% elsif first_media.media_type == 'external_video' %}
            {{ first_media | external_video_tag }}
          {% endif %}
        </div>

        {%- comment -%} CART CONTROLS (Quantity + Button) - After first image {%- endcomment -%}
        <div class="a24-cart-controls" data-a24-cart-controls>
          <div class="a24-cart-controls__inner" data-a24-cart-inner>
            {% render 'a24-purchase-bar' %}
          </div>
          <div class="a24-cart-controls__placeholder" aria-hidden="true"></div>
        </div>

        {%- comment -%} REMAINING IMAGES {%- endcomment -%}
        {% if closest.product.media.size > 1 %}
          <div class="product-information-a24__media">
            {% for media in closest.product.media offset: 1 %}
              <div class="a24-media-item">
                {% if media.media_type == 'image' %}
                  <img
                    src="{{ media | image_url: width: 1200 }}"
                    alt="{{ media.alt | escape }}"
                    width="{{ media.width }}"
                    height="{{ media.height }}"
                    loading="lazy"
                    class="a24-media-item__image"
                  >
                {% elsif media.media_type == 'video' %}
                  {{ media | video_tag: autoplay: true, loop: true, muted: true, controls: false }}
                {% elsif media.media_type == 'external_video' %}
                  {{ media | external_video_tag }}
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}
      
    </div>

  </div>

  {{ additional_blocks }}
</div>

{% stylesheet %}
  /* ============================================
     A24 PDP Layout Styles - Phase 2 Refined
     ============================================ */
  
  .product-information-a24 {
    --a24-gap: 64px;
    --a24-left-width: 380px;
    --a24-right-max-width: 100%;
    --a24-purchase-bar-height: auto;
    --a24-header-offset: var(--header-height, 0px);
    --a24-sticky-top: 32px;
    
    /* Force A24 background color */
    background-color: #f1f1f1 !important;
    color: #000000 !important;
  }

  .product-information-a24__container {
    display: grid;
    grid-template-columns: var(--a24-left-width) 1fr;
    gap: var(--a24-gap);
    max-width: 100%;
    margin: 0 auto;
    padding: 48px 40px;
    align-items: stretch;
    min-height: calc(100vh - 100px);
  }

  /* LEFT COLUMN: Flex container to push content down */
  .product-information-a24__left {
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* Push content to bottom */
    align-items: flex-start;
    position: relative;
  }

  /* Spacer pushes content down */
  .product-information-a24__spacer {
    flex: 1 1 auto; /* Takes up available space */
    min-height: 100px; /* Minimum space above content */
  }

  /* Content wrapper at bottom */
  .product-information-a24__left-content {
    flex: 0 0 auto;
    width: 100%;
    position: sticky;
    bottom: 48px;
  }

  /* Left content wrapper - flex for ordering */
  .product-information-a24__left-content {
    display: flex;
    flex-direction: column;
  }

  /* Hide buy-buttons from left column (they go in purchase bar) */
  .product-information-a24__left .buy-buttons {
    display: none !important;
  }

  /* Hide default price block (we use custom A24 pricing) */
  .product-information-a24__left .price {
    display: none !important;
  }

  /* Hide accelerated checkout in left column */
  .product-information-a24__left .accelerated-checkout,
  .product-information-a24__left .shopify-payment-button {
    display: none !important;
  }

  /* A24 Pricing Display - positioned after title */
  .product-information-a24__pricing {
    order: 2;
    margin-top: 8px;
    margin-bottom: 32px;
  }

  /* Product details block */
  .product-information-a24__left .product-details {
    order: 3;
  }

  /* Product details group wrapper */
  .product-information-a24__left .product-details .group-block {
    display: flex;
    flex-direction: column;
  }

  /* Force specific elements to reorder within product details */
  .product-information-a24__left .product-details h1,
  .product-information-a24__left .product-details [class*="product-title"],
  .product-information-a24__left .product-details [class*="heading"] {
    order: 1;
  }

  /* RIGHT COLUMN: Media + Purchase Bar */
  .product-information-a24__right {
    display: flex;
    flex-direction: column;
    gap: 0; /* Tighter layout - gaps controlled individually */
    max-width: var(--a24-right-max-width);
    width: 100%;
  }

  /* First image - no margin */
  .a24-media-item--first {
    margin-bottom: 0;
  }

  /* Purchase Bar (at bottom of right column, NOT sticky on desktop) */
  .product-information-a24__purchase-bar {
    position: relative;
    z-index: 10;
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 0;
    max-width: 500px; /* Narrower like A24 */
    width: 100%;
  }

  .a24-purchase-bar__content {
    /* Will be styled in Phase 3 */
  }

  /* ============================================
     A24 Media Stack - Simple Vertical Scroll
     No carousel, no lightbox, no interactions
     ============================================ */
  
  .product-information-a24__media {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }

  /* Individual media item container */
  .a24-media-item {
    width: 100%;
    position: relative;
  }

  /* Images - simple, non-interactive */
  .a24-media-item__image {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
    pointer-events: none;
    cursor: default;
    user-select: none;
    -webkit-user-drag: none;
  }

  /* Videos */
  .a24-media-item video {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
  }

  /* No hover effects */
  .a24-media-item:hover {
    transform: none;
    box-shadow: none;
  }

  /* ============================================
     A24 Cart Controls - Between First Image & Rest
     Sticky behavior with state transitions
     ============================================ */
  
  .a24-cart-controls {
    position: relative;
    width: 100%;
    margin: 32px 0 24px 0;
  }

  /* Gap before remaining images */
  .product-information-a24__media {
    margin-top: 8px;
  }

  .a24-cart-controls__inner {
    position: relative;
    transition: all 0.3s ease;
  }

  /* When sticky - fixed at top */
  .a24-cart-controls.is-sticky .a24-cart-controls__inner {
    position: fixed;
    top: 24px;
    right: 40px;
    left: auto;
    width: auto;
    z-index: 999;
  }

  /* Hide quantity when sticky */
  .a24-cart-controls.is-sticky .a24-quantity-selector {
    display: none !important;
  }

  /* Transform button to black when sticky */
  .a24-cart-controls.is-sticky .a24-add-to-cart {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-color: #000000 !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
  }

  .a24-cart-controls.is-sticky .a24-add-to-cart:hover:not(:disabled) {
    background-color: #333333 !important;
    border-color: #333333 !important;
  }

  /* Hide the purchase bar content layout wrapper when sticky */
  .a24-cart-controls.is-sticky .a24-purchase-bar__content {
    gap: 0 !important;
  }

  /* Placeholder to maintain layout when sticky */
  .a24-cart-controls__placeholder {
    display: none;
    height: 100px; /* Approximate height of cart controls */
  }

  .a24-cart-controls.is-sticky .a24-cart-controls__placeholder {
    display: block;
  }

  /* MOBILE: Single column, purchase bar at bottom */
  @media screen and (max-width: 749px) {
    .product-information-a24 {
      --a24-sticky-top: 16px;
    }

    .product-information-a24__container {
      grid-template-columns: 1fr;
      gap: 24px;
      padding: 24px var(--padding-md, 16px) 140px;
      min-height: auto;
      align-items: flex-start;
    }

    .product-information-a24__left {
      position: static;
      order: 1;
      justify-content: flex-start;
    }

    .product-information-a24__spacer {
      display: none; /* No spacer on mobile */
    }

    .product-information-a24__left-content {
      position: static;
    }

    .product-information-a24__left .buy-buttons {
      display: none !important;
    }

    .product-information-a24__right {
      order: 0;
      max-width: 100%;
    }

    /* Cart controls - fixed at bottom on mobile */
    .a24-cart-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: auto;
      z-index: 100;
      background: #f1f1f1;
      border-top: 1px solid #a8a8a8;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin: 0;
    }

    /* On mobile, never use sticky top behavior */
    .a24-cart-controls.is-sticky .a24-cart-controls__inner {
      position: relative;
      top: auto;
      right: auto;
      width: 100%;
    }

    /* Show quantity on mobile even when "sticky" */
    .a24-cart-controls.is-sticky .a24-quantity-selector {
      display: flex !important;
    }

    /* Keep button outlined on mobile */
    .a24-cart-controls.is-sticky .a24-add-to-cart {
      background-color: transparent !important;
      color: #000000 !important;
      border-color: #000000 !important;
      box-shadow: none !important;
    }

    .product-information-a24__media {
      order: 1;
      gap: 12px;
    }
  }

  /* TABLET: Adjust left column width */
  @media screen and (min-width: 750px) and (max-width: 1023px) {
    .product-information-a24 {
      --a24-left-width: 320px;
      --a24-gap: 48px;
    }

    .product-information-a24__container {
      padding: 32px 24px;
    }

    /* Tablet sticky position */
    .a24-cart-controls.is-sticky .a24-cart-controls__inner {
      right: 24px;
      top: 20px;
    }
  }

  /* Hide the separate sticky button from purchase bar - we handle it here */
  .a24-sticky-button {
    display: none !important;
  }

  /* LARGE DESKTOP: Maintain full-width feel */
  @media screen and (min-width: 1400px) {
    .product-information-a24 {
      --a24-left-width: 420px;
      --a24-gap: 80px;
    }

    .product-information-a24__container {
      padding: 64px 60px;
    }
  }

  /* If header is sticky, adjust offset */
  body:has(#header-group #header-component[data-sticky-state='active']) .product-information-a24 {
    --a24-header-offset: var(--header-height);
  }

  /* Minimal typography overrides for A24 aesthetic */
  .product-information-a24__left h1 {
    font-weight: 400;
    letter-spacing: -0.02em;
  }

  .product-information-a24__left .price {
    font-weight: 500;
  }

  /* Smooth scroll behavior */
  .product-information-a24__left {
    scroll-behavior: smooth;
  }

{% endstylesheet %}

<script>
  // A24 Section - Sticky Cart Controls Behavior
  (function() {
    const cartControls = document.querySelector('[data-a24-cart-controls]');
    if (!cartControls) return;

    const cartInner = cartControls.querySelector('[data-a24-cart-inner]');
    if (!cartInner) return;

    // Get the initial position of cart controls
    let initialTop = 0;
    let controlsHeight = 0;
    let isSticky = false;

    function updateMeasurements() {
      // Only measure when not sticky
      if (!isSticky) {
        const rect = cartControls.getBoundingClientRect();
        initialTop = rect.top + window.scrollY;
        controlsHeight = cartControls.offsetHeight;
      }
    }

    function handleScroll() {
      const scrollY = window.scrollY;
      const headerHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height') || '0', 10);
      const triggerPoint = initialTop - headerHeight - 24; // 24px offset from top

      if (scrollY > triggerPoint) {
        if (!isSticky) {
          isSticky = true;
          cartControls.classList.add('is-sticky');
          // Set placeholder height to prevent layout jump
          cartControls.style.minHeight = controlsHeight + 'px';
        }
      } else {
        if (isSticky) {
          isSticky = false;
          cartControls.classList.remove('is-sticky');
          cartControls.style.minHeight = '';
        }
      }
    }

    // Initial measurements
    updateMeasurements();

    // Throttled scroll handler
    let ticking = false;
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });

    // Recalculate on resize (debounced)
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        // Reset sticky state to get accurate measurements
        if (isSticky) {
          isSticky = false;
          cartControls.classList.remove('is-sticky');
          cartControls.style.minHeight = '';
        }
        updateMeasurements();
        handleScroll();
      }, 150);
    }, { passive: true });

    // Initial check in case page is already scrolled
    handleScroll();
  })();
</script>

{% schema %}
{
  "name": "Product Information A24",
  "class": "section-product-information-a24",
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "content-center-aligned",
          "label": "t:options.page"
        },
        {
          "value": "content-full-width",
          "label": "t:options.full"
        }
      ],
      "default": "content-full-width"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "t:settings.media_position",
      "options": [
        {
          "value": "left",
          "label": "t:options.left"
        },
        {
          "value": "right",
          "label": "t:options.right"
        }
      ],
      "default": "right",
      "info": "A24 layout always shows media on right"
    },
    {
      "type": "checkbox",
      "id": "equal_columns",
      "label": "t:settings.equal_columns",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "limit_details_width",
      "label": "t:settings.limit_product_details_width",
      "default": false
    },
    {
      "type": "range",
      "id": "gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 96,
      "step": 4,
      "unit": "px",
      "default": 48
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": []
}
{% endschema %}
